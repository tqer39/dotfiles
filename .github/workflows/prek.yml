---
name: prek

on:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prek:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      prek-failed: ${{ steps.prek.outcome == 'failure' }}
      prek-log: ${{ steps.save-log.outputs.log }}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}

      - uses: j178/prek-action@v1
        id: prek
        continue-on-error: true
        with:
          extra_args: --all-files

      - name: Save prek log
        id: save-log
        if: steps.prek.outcome == 'failure'
        run: |
          log=$(cat ~/.cache/prek/prek.log 2>/dev/null | tail -100 || echo "No log available")
          # GitHub outputs の制限対策（改行をエスケープ）
          log="${log//'%'/'%25'}"
          log="${log//$'\n'/'%0A'}"
          log="${log//$'\r'/'%0D'}"
          echo "log=$log" >> "$GITHUB_OUTPUT"

      - name: Fail if prek failed on main
        if: steps.prek.outcome == 'failure' && github.event_name != 'pull_request'
        run: exit 1

  autofix:
    needs: prek
    if: needs.prek.outputs.prek-failed == 'true' && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    # 手動承認が必要（無限ループ防止）
    environment: claude-autofix
    permissions:
      # Claude Code Action がファイルを修正してコミットするために必要
      contents: write
      # Claude Code Action が PR にコメントを投稿するために必要
      pull-requests: write
      # Claude Code Action が OIDC トークンを取得するために必要
      id-token: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-fix with Claude Code Action
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            pre-commit チェックが失敗しました。以下のログを確認して修正してください：

            ```
            ${{ needs.prek.outputs.prek-log }}
            ```

            各エラーの修正方法：
            - end-of-file-fixer: ファイル末尾に改行を追加
            - trailing-whitespace: 行末の空白を削除
            - mixed-line-ending: 改行コードをLFに統一
            - shellcheck: シェルスクリプトの問題を修正
            - markdownlint: Markdownの問題を修正
            - textlint: 日本語の問題を修正
            - cspell: Unknown word エラーは cspell.json の words 配列に単語を追加（アルファベット順）
            - ruff: Pythonのフォーマットとリントを修正

            修正後、コミットしてください。
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
