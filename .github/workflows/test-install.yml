name: Test Install Scripts

on:
  push:
    branches: [main]
    paths:
      - 'install.sh'
      - 'install.ps1'
      - 'scripts/**'
      - 'config/**'
      - 'src/**'
      - '.github/workflows/test-install.yml'
  pull_request:
    paths:
      - 'install.sh'
      - 'install.ps1'
      - 'scripts/**'
      - 'config/**'
      - 'src/**'
      - '.github/workflows/test-install.yml'
  workflow_dispatch:

jobs:
  # ------------------------------------------------------------------------------
  # Minimal Install Tests (symlinks only, fast)
  # ------------------------------------------------------------------------------
  test-unix-minimal:
    name: Minimal - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    env:
      DOTFILES_DIR: ${{ github.workspace }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Test dry-run mode
        run: |
          echo "=== Testing dry-run mode ==="
          bash install.sh --dry-run --verbose --ci

      - name: Test minimal install
        run: |
          echo "=== Testing minimal install ==="
          bash install.sh --minimal --ci

      - name: Verify symlinks created
        run: |
          echo "=== Verifying symlinks ==="
          if [ -L ~/.gitconfig ] || [ -L ~/.zshrc ] || [ -L ~/.bashrc ]; then
            echo "Symlinks created successfully"
          else
            echo "Warning: No expected symlinks found"
          fi
          ls -la ~ | grep "^l" || true

      - name: Test status command
        run: |
          echo "=== Testing status command ==="
          bash scripts/dotfiles.sh status

      - name: Test uninstall
        run: |
          echo "=== Testing uninstall ==="
          bash install.sh --uninstall --ci

      - name: Verify uninstall
        run: |
          echo "=== Verifying uninstall ==="
          if [ -L ~/.gitconfig ] || [ -L ~/.zshrc ] || [ -L ~/.bashrc ]; then
            echo "Warning: Some symlinks still exist after uninstall"
            ls -la ~ | grep "^l" || true
          else
            echo "Uninstall completed successfully"
          fi

  # ------------------------------------------------------------------------------
  # Full Install Tests (packages + runtimes)
  # Runs only on main branch (after merge) to reduce CI time for PRs
  # ------------------------------------------------------------------------------
  test-unix-full:
    name: Full - ${{ matrix.os }}
    if: github.ref == 'refs/heads/main'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    env:
      DOTFILES_DIR: ${{ github.workspace }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Cache Homebrew
        if: runner.os == 'macOS'
        uses: actions/cache@v5
        with:
          path: |
            ~/Library/Caches/Homebrew
            /opt/homebrew/Cellar
          key: ${{ runner.os }}-brew-${{ hashFiles('config/packages/Brewfile') }}
          restore-keys: |
            ${{ runner.os }}-brew-

      - name: Cache APT packages
        if: runner.os == 'Linux'
        uses: actions/cache@v5
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('config/packages/apt-packages.txt') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Test full install
        run: |
          echo "=== Testing full install ==="
          bash install.sh --full --ci
        timeout-minutes: 30

      - name: Verify CLI tools installed
        run: |
          echo "=== Verifying CLI tools ==="
          # Check common CLI tools
          command -v starship && starship --version || echo "starship not found"
          command -v gh && gh --version || echo "gh not found"
          command -v eza && eza --version || echo "eza not found"
          command -v bat && bat --version || echo "bat not found"
          command -v fzf && fzf --version || echo "fzf not found"
          command -v rg && rg --version || echo "ripgrep not found"

      - name: Verify language runtimes
        run: |
          echo "=== Verifying language runtimes ==="
          # Check anyenv and *env installations
          if [ -d ~/.anyenv ]; then
            echo "anyenv installed"
            export PATH="$HOME/.anyenv/bin:$PATH"
            eval "$(anyenv init -)"
            command -v pyenv && pyenv --version || echo "pyenv not found"
            command -v nodenv && nodenv --version || echo "nodenv not found"
          else
            echo "anyenv not found"
          fi

  # ------------------------------------------------------------------------------
  # Windows Minimal Tests
  # ------------------------------------------------------------------------------
  test-windows-minimal:
    name: Minimal - Windows
    runs-on: windows-latest
    env:
      DOTFILES_DIR: ${{ github.workspace }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Test dry-run mode
        shell: pwsh
        run: |
          Write-Host "=== Testing dry-run mode ==="
          .\install.ps1 -DryRun -Verbose -CI

      - name: Test minimal install
        shell: pwsh
        run: |
          Write-Host "=== Testing minimal install ==="
          .\install.ps1 -Minimal -CI

      - name: Verify symlinks created
        shell: pwsh
        run: |
          Write-Host "=== Verifying symlinks ==="
          $gitconfig = "$env:USERPROFILE\.gitconfig"
          if (Test-Path $gitconfig) {
            $item = Get-Item $gitconfig -Force
            if ($item.Attributes -band [System.IO.FileAttributes]::ReparsePoint) {
              Write-Host "Symlink created successfully: $gitconfig"
            } else {
              Write-Host "File exists but is not a symlink: $gitconfig"
            }
          } else {
            Write-Host "File not found: $gitconfig"
          }

      - name: Test uninstall
        shell: pwsh
        run: |
          Write-Host "=== Testing uninstall ==="
          .\install.ps1 -Uninstall -CI

      - name: Verify uninstall
        shell: pwsh
        run: |
          Write-Host "=== Verifying uninstall ==="
          $gitconfig = "$env:USERPROFILE\.gitconfig"
          if (Test-Path $gitconfig) {
            $item = Get-Item $gitconfig -Force
            if ($item.Attributes -band [System.IO.FileAttributes]::ReparsePoint) {
              Write-Host "Warning: Symlink still exists: $gitconfig"
            } else {
              Write-Host "File restored from backup or unchanged"
            }
          } else {
            Write-Host "Uninstall completed successfully"
          }

  # ------------------------------------------------------------------------------
  # Windows Full Tests
  # Runs only on main branch (after merge) to reduce CI time for PRs
  # ------------------------------------------------------------------------------
  test-windows-full:
    name: Full - Windows
    if: github.ref == 'refs/heads/main'
    runs-on: windows-latest
    env:
      DOTFILES_DIR: ${{ github.workspace }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Cache Scoop
        uses: actions/cache@v5
        with:
          path: ~/scoop/cache
          key: windows-scoop-${{ hashFiles('install.ps1') }}
          restore-keys: |
            windows-scoop-

      - name: Test full install
        shell: pwsh
        run: |
          Write-Host "=== Testing full install ==="
          .\install.ps1 -Full -CI
        timeout-minutes: 20

      - name: Verify Scoop packages installed
        shell: pwsh
        run: |
          Write-Host "=== Verifying Scoop packages ==="
          if (Get-Command scoop -ErrorAction SilentlyContinue) {
            Write-Host "Scoop installed"
            scoop list
          } else {
            Write-Host "Scoop not found"
          }
          # Check CLI tools
          if (Get-Command starship -ErrorAction SilentlyContinue) {
            starship --version
          } else {
            Write-Host "starship not found"
          }
          if (Get-Command gh -ErrorAction SilentlyContinue) {
            gh --version
          } else {
            Write-Host "gh not found"
          }
